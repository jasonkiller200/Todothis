# 通知功能實作規劃

## 總覽
本規劃旨在為 Todothis 系統新增 Gmail 郵件通知功能，以提升使用者對任務狀態的掌握度。通知將涵蓋任務到期、新任務指派、任務完成以及任務延誤等情境。

## 規劃步驟

### 1. 新增郵件發送功能
       使用用公司 mail api

### 2. 設計通知邏輯

*   **今天到期任務通知：**
    *   **觸發條件：** 每天定時檢查所有用戶「今天到期」且狀態為「待開始」或「進行中」的任務。
    *   **發送對象：** 任務負責人。
    *   **排程時間：** 每天早上 08:00 (台灣時間)。
    *   **郵件主題：** `[今天到期] 任務標題`
    *   **郵件主文：** 包含任務標題、描述、到期日、指派人姓名等詳細資訊。

*   **收到指派任務通知：**
    *   **觸發條件：** 在 `add_todo` 和 `batch_add_todo` 函數中，任務成功指派後立即觸發。
    *   **發送對象：** 被指派人。
    *   **排除條件：** 如果指派人與被指派人是同一人，則不發送通知。
    *   **郵件主題：** `[新任務指派] 任務標題`
    *   **郵件主文：** 包含任務標題、描述、到期日、指派人姓名等詳細資訊。

*   **指派者已派出任務完成通知：**
    *   **觸發條件：** 在 `update_todo_status` 函數中，當任務狀態從「進行中」或「待開始」變更為「已完成」時，且該任務有指派人 (`assigned_by_user_id` 不為空) 時觸發。
    *   **發送對象：** 任務指派人。
    *   **排除條件：** 如果指派人與任務負責人是同一人，則不發送通知。
    *   **郵件主題：** `[任務完成] 任務標題`
    *   **郵件主文：** 包含任務標題、描述、到期日、指派人姓名等詳細資訊。

*   **任務延誤通知：**
    *   **觸發條件：** 每天定時檢查所有用戶「已逾期」(預計完成日已過) 且狀態為「待開始」或「進行中」的任務。
    *   **發送對象：** 任務負責人及指派人。
    *   **排程時間：** 每天早上 08:00 (台灣時間)。
    *   **排除條件：** 如果負責人與指派人是同一人，則只發送一封郵件。
    *   **郵件主題：** `[任務延誤] 任務標題`
    *   **郵件主文：** 包含任務標題、描述、到期日、指派人姓名等詳細資訊。
    *   **郵件發送地址選擇：** 在發送郵件時，根據用戶的設定選擇發送到內部郵件地址 (`user.email`) 。

### 3. 規劃使用者訂閱管理

*   **User 模型更新：** 在 `User` 模型中新增兩個欄位：
    *   `notification_enabled` (布林值)，預設為 `True`。
*   **管理員介面：** 在管理員介面 (`admin_users.html` 和 `edit_user.html`) 中，為管理員提供一個選項來啟用或禁用特定用戶的通知功能。
*   **使用者個人設定頁面：** 創建一個新的 HTML 模板和對應的 Flask 路由，讓使用者可以自行管理其通知訂閱狀態。此頁面將包含：
    *   啟用/禁用通知的選項。
    
*   **發送前檢查：** 在發送任何郵件前，檢查目標用戶的 `notification_enabled` 狀態，

### 4. 錯誤處理和日誌記錄

*   **錯誤捕獲：** 在郵件發送函數中加入 `try-except` 區塊，捕獲郵件發送失敗的錯誤。
*   **日誌記錄：** 將郵件發送的成功與失敗記錄到日誌中，以便追蹤和排查問題。



