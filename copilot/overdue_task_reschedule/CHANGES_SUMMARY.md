# 📋 逾期任務重設預計完成日期功能 - 變更摘要

## 🎯 功能概述
當逾期任務（Todo 或 MeetingTask）被標記為「未完成」時，使用者現在可以：
1. ✅ 填寫未完成原因（原有功能）
2. ✅ **重新設定預計完成日期**（新增功能）
3. ✅ 所有變更都會記錄到履歷中
4. ✅ 每日逾期提醒郵件會引導使用者使用此功能

## 📦 修改的檔案

### 1. `app.py` - 後端 API
- **位置**: `update_todo_status()` 函數 (約 line 1618-1715)
- **變更**:
  - 接收新參數 `new_due_date`
  - 更新 Todo 的 `due_date`
  - 記錄日期變更到 `history_log`
  - 同步更新關聯的 MeetingTask

### 2. `static/js/main.js` - 前端邏輯
- **變更位置**:
  - Line 145-157: 添加日期選擇器 HTML
  - Line 173-196: 添加日期變更履歷顯示
  - Line 383-406: 添加日期驗證邏輯
  - Line 409-430: 修改 API 調用函數
- **新增功能**:
  - datetime-local 輸入控件
  - 前端必填驗證
  - 日期變更事件顯示

### 3. `scheduler.py` - 郵件通知
- **位置**: `check_overdue_tasks()` 函數 (約 line 90-107)
- **變更**: 在逾期提醒郵件中添加使用提示

### 4. `static/css/styles.css` - 樣式
- **位置**: 約 line 286-330
- **新增**: 日期輸入框和標籤樣式

## 🔄 資料流程

```
使用者操作
    ↓
選擇「未完成」→ 填寫原因 → 選擇新日期
    ↓
前端驗證（兩個欄位都必填）
    ↓
發送 API 請求：PUT /api/todo/<id>/status
    {
        "status": "uncompleted",
        "uncompleted_reason": "原因文字",
        "new_due_date": "ISO日期"
    }
    ↓
後端處理
    ├─ 更新 Todo.due_date
    ├─ 記錄日期變更到 history_log
    ├─ 記錄未完成事件到 history_log
    ├─ 狀態自動切換為 'in-progress'
    └─ 同步更新 MeetingTask（如果存在）
    ↓
返回成功訊息 → 前端重新載入
```

## ✅ 完成狀態

| 項目 | 狀態 | 說明 |
|------|------|------|
| 後端 API | ✅ 完成 | 日期解析、更新、記錄都正常 |
| 前端界面 | ✅ 完成 | 輸入控件、驗證、顯示都正常 |
| MeetingTask 同步 | ✅ 完成 | 日期和履歷同步正常 |
| 郵件通知 | ✅ 完成 | 提示訊息已添加 |
| CSS 樣式 | ✅ 完成 | 輸入框美化完成 |
| 語法檢查 | ✅ 通過 | Python 和 JavaScript 無語法錯誤 |
| 單元測試 | ✅ 通過 | 日期解析、履歷格式都正確 |

## 🧪 測試建議

### 快速測試流程
1. **建立測試任務**
   ```
   - 建立一個 Todo，due_date 設為昨天
   - 確認顯示紅色逾期標記
   ```

2. **測試重設日期**
   ```
   - 選擇「未完成」狀態
   - 填寫：「測試重設日期功能」
   - 選擇：明天的日期和時間
   - 點擊「確認」
   ```

3. **驗證結果**
   ```
   ✅ 狀態變為「進行中」
   ✅ 預計完成日期已更新
   ✅ 履歷顯示兩筆記錄
   ✅ 紅色逾期標記消失
   ```

4. **測試驗證**
   ```
   - 只填原因不選日期 → 應提示錯誤
   - 只選日期不填原因 → 應提示錯誤
   ```

## 📊 數據庫影響

| 項目 | 影響 |
|------|------|
| 資料表結構 | ❌ 無變更 |
| 欄位新增 | ❌ 無新增 |
| 資料遷移 | ❌ 不需要 |
| 向後兼容 | ✅ 完全兼容 |

## 🚀 部署檢查清單

- [ ] 備份資料庫
- [ ] 備份關鍵檔案（app.py, main.js）
- [ ] 停止應用服務
- [ ] 部署新檔案
- [ ] 重啟應用服務
- [ ] 清除瀏覽器快取
- [ ] 執行快速測試
- [ ] 監控日誌
- [ ] 通知使用者新功能

## 📝 新功能使用說明

### 給使用者的簡要說明

**如何重設逾期任務的完成日期？**

1. 找到逾期任務（紅色標記）
2. 在狀態下拉選單選擇「未完成」
3. 填寫未完成原因
4. 選擇新的預計完成日期
5. 點擊「確認」按鈕

任務會自動切換回「進行中」狀態，並使用新的完成日期。所有變更都會記錄在任務履歷中。

## 🎉 總結

✅ **零風險部署** - 無資料庫變更，完全向後兼容  
✅ **測試通過** - 語法和邏輯測試都正常  
✅ **功能完整** - 前後端、郵件、同步都已實現  
✅ **使用者友善** - 清楚的提示和驗證  

**可以立即部署到生產環境！** 🚀
