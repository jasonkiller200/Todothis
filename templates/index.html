<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每週待辦事項管理系統</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body data-current-user-key="{{ current_user.user_key }}" data-current-user-name="{{ current_user.name }}">
    <div class="container">
        <div class="header">
            <h1>🏭 每週待辦事項管理系統</h1>
            {% if current_user %}
            <div class="user-info-header">
                <div>{{ current_user.avatar }} <strong>{{ current_user.name }}</strong></div>
                <div class="user-actions">
                    <a href="{{ url_for('change_password') }}">🔒 更改密碼</a>
                    <a href="{{ url_for('user_settings') }}">⚙️ 個人設定</a>
                    {% if current_user.level == 'admin' %}
                        <a href="{{ url_for('admin_users') }}">⚙️ 管理後台</a>
                    {% endif %}
                    {% if current_user.level in ['admin', 'executive-manager', 'plant-manager', 'manager', 'assistant-manager', 'section-chief', 'deputy-section-chief'] %}
                        <a href="{{ url_for('reports') }}">📊 報告中心</a>
                    {% endif %}
                    <a href="{{ url_for('meeting_tasks') }}">📝 會議任務指派</a>
                    <a href="{{ url_for('scheduled_notifications') }}">⏰ 定時通知設定</a> {# New link #}
                    {% if current_user.level in ['admin', 'executive-manager', 'plant-manager', 'manager', 'section-chief', 'deputy-section-chief'] %}
                    <a href="{{ url_for('report_settings') }}">📅 週報設定</a>
                    {% endif %}
                    <a href="{{ url_for('logout') }}">🚪 登出</a>
                </div>
            </div>
            {% endif %}
    </div>

        <div class="main-content">
            <div class="org-chart">
                <h3>📊 組織架構圖</h3>
                <div class="tree-container">
                    {% if director %}
                    <div class="level director-level">
                        <div class="level-node">
                            <div class="user-card" data-user-key="{{ director.user_key }}">
                                <span class="user-avatar">{{ director.avatar }}</span>
                                <div class="user-details">
                                    <div class="user-name">{{ director.name }}</div>
                                    <div class="user-role">{{ director.role }}</div>
                                    <div class="user-task-stats">
                                        本週進度: {{ director.completed_tasks }} / {{ director.total_tasks }}
                                    </div>
                                    <div class="user-progress-bar">
                                        <div class="user-progress-fill" style="width: {% if director.total_tasks > 0 %}{{ (director.completed_tasks / director.total_tasks) * 100 }}{% else %}0{% endif %}%;"></div>
                                    </div>
                                    {% if director.overdue_tasks > 0 %}
                                    <div class="overdue-task-stats">
                                        逾期任務: {{ director.overdue_tasks }}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}

                    <div class="level departments-grid">
                        {% for dept_name, data in departments.items() %}
                            <div class="level-node department-card" style="border-color: {{ loop.cycle('#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6') }};">
                                <h4>{{ dept_name }}</h4>
                                <div class="team-grid">
                                    {% if data.management_team %}
                                    <div class="leaders-section">
                                        <h6>主管</h6>
                                        {% for manager in data.management_team %}
                                        <div class="user-card" data-user-key="{{ manager.user_key }}">
                                            <span class="user-avatar">{{ manager.avatar }}</span>
                                            <div class="user-details">
                                                <div class="user-name">{{ manager.name }}</div>
                                                <div class="user-role">{{ manager.role }}</div>
                                                <div class="user-task-stats">
                                                    本週進度: {{ manager.completed_tasks }} / {{ manager.total_tasks }}
                                                </div>
                                                <div class="user-progress-bar">
                                                    <div class="user-progress-fill" style="width: {% if manager.total_tasks > 0 %}{{ (manager.completed_tasks / manager.total_tasks) * 100 }}{% else %}0{% endif %}%;"></div>
                                                </div>
                                                {% if manager.overdue_tasks > 0 %}
                                                <div class="overdue-task-stats">
                                                    逾期任務: {{ manager.overdue_tasks }}
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    {% endif %}

                                    {% for unit_name, unit_data in data.units.items() %}
                                    <div class="unit-section">
                                        <h5>{{ unit_name }}</h5>
                                        {% if unit_data.management_team %}
                                        <div class="leaders-section">
                                            <h6>主管</h6>
                                            {% for manager in unit_data.management_team %}
                                            <div class="user-card" data-user-key="{{ manager.user_key }}">
                                                <span class="user-avatar">{{ manager.avatar }}</span>
                                                <div class="user-details">
                                                    <div class="user-name">{{ manager.name }}</div>
                                                    <div class="user-role">{{ manager.role }}</div>
                                                    <div class="user-task-stats">
                                                        本週進度: {{ manager.completed_tasks }} / {{ manager.total_tasks }}
                                                    </div>
                                                    <div class="user-progress-bar">
                                                        <div class="user-progress-fill" style="width: {% if manager.total_tasks > 0 %}{{ (manager.completed_tasks / manager.total_tasks) * 100 }}{% else %}0{% endif %}%;"></div>
                                                    </div>
                                                    {% if manager.overdue_tasks > 0 %}
                                                    <div class="overdue-task-stats">
                                                        逾期任務: {{ manager.overdue_tasks }}
                                                    </div>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% endif %}

                                        {% if unit_data.leaders %}
                                        <div class="leaders-section">
                                            <h6>組長</h6>
                                            {% for leader in unit_data.leaders %}
                                            <div class="user-card" data-user-key="{{ leader.user_key }}">
                                                <span class="user-avatar">{{ leader.avatar }}</span>
                                                <div class="user-details">
                                                <div class="user-name">{{ leader.name }}</div>
                                                <div class="user-role">{{ leader.role }}</div>
                                                <div class="user-task-stats">
                                                    本週進度: {{ leader.completed_tasks }} / {{ leader.total_tasks }}
                                                </div>
                                                <div class="user-progress-bar">
                                                    <div class="user-progress-fill" style="width: {% if leader.total_tasks > 0 %}{{ (leader.completed_tasks / leader.total_tasks) * 100 }}{% else %}0{% endif %}%;"></div>
                                                </div>
                                                {% if leader.overdue_tasks > 0 %}
                                                <div class="overdue-task-stats">
                                                    逾期任務: {{ leader.overdue_tasks }}
                                                </div>
                                                {% endif %}
                                            </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% endif %}

                                        {% if unit_data.staff %}
                                        <div class="staff-section">
                                            <h6>作業員</h6>
                                            {% for member in unit_data.staff %}
                                            <div class="user-card" data-user-key="{{ member.user_key }}">
                                                <span class="user-avatar">{{ member.avatar }}</span>
                                                <div class="user-details">
                                                <div class="user-name">{{ member.name }}</div>
                                                <div class="user-role">{{ member.role }}</div>
                                                <div class="user-task-stats">
                                                    本週進度: {{ member.completed_tasks }} / {{ member.total_tasks }}
                                                </div>
                                                <div class="user-progress-bar">
                                                    <div class="user-progress-fill" style="width: {% if member.total_tasks > 0 %}{{ (member.completed_tasks / member.total_tasks) * 100 }}{% else %}0{% endif %}%;"></div>
                                                </div>
                                                {% if member.overdue_tasks > 0 %}
                                                <div class="overdue-task-stats">
                                                    逾期任務: {{ member.overdue_tasks }}
                                                </div>
                                                {% endif %}
                                            </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            </div>

            <div class="dept-performance">
                <h3>📈 各部門達成效果</h3>
                <div id="dept-stats">
                    <!-- Dept stats will be loaded here by JS -->
                </div>
            </div>

            <div class="dashboard">
                <div class="user-detail">
                    <h3>👤 個人工作詳情</h3>
                    <div id="user-content">
                        <div class="no-user-selected">請點擊上方組織圖中的人員以查看詳細資訊</div>
                    </div>
                </div>
                <div id="add-todo-form-container" class="add-todo-form" style="display: none;">
                    <h3>➕ 新增待辦事項</h3>
                    <form id="todoForm">
                        <div class="form-group" id="assign-to-group" style="display: none;">
                            <label for="assign-to">指派給 (可複選)</label>
                            <select id="assign-to" required multiple size="5">
                                <!-- Options will be loaded by JS -->
                            </select>
                        </div>
                        <div id="no-assignable-users-message" style="display: none; color: #dc3545; margin-bottom: 15px; text-align: center;">
                            您沒有可指派的人員。
                        </div>
                        <div class="form-group">
                            <label for="todo-type">類型</label>
                            <select id="todo-type" required><option value="current">本週任務</option><option value="next" selected>未來任務</option></select>
                        </div>
                        <div class="form-group">
                            <label for="due-date">預計完成日期</label>
                            <input type="date" id="due-date" required>
                        </div>
                        <div class="form-group">
                            <label for="todo-title">標題</label>
                            <input type="text" id="todo-title" required>
                        </div>
                        <div class="form-group">
                            <label for="todo-description">描述</label>
                            <textarea id="todo-description" required rows="5"></textarea>
                        </div>
                        <button type="submit" class="btn">新增</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
