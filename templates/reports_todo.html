<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo 任務報告</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
    <style>
        :root {
            --color-primary: #667eea;
            --color-secondary: #764ba2;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-info: #3b82f6;
            --color-background: #f0f2f5;
            --color-white: #fff;
            --color-text: #333;
            --color-text-light: #666;
            --color-border: #e5e7eb;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--color-text);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--color-white);
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            padding: 30px;
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* 頂部導航 */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--color-background);
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
        }
        
        .nav-tab {
            padding: 10px 20px;
            background: var(--color-background);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            text-decoration: none;
            color: var(--color-text);
        }
        
        .nav-tab:hover {
            background: var(--color-primary);
            color: white;
            transform: translateY(-2px);
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: white;
        }
        
        .btn-home {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-home:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        /* 頁面標題 */
        .page-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .page-header h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        
        .page-header p {
            color: var(--color-text-light);
            font-size: 1.1em;
        }
        
        /* 統計卡片 */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--color-background) 0%, #fff 100%);
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            transition: all 0.3s;
            border-left: 4px solid var(--color-primary);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-card.success { border-left-color: var(--color-success); }
        .stat-card.warning { border-left-color: var(--color-warning); }
        .stat-card.danger { border-left-color: var(--color-danger); }
        .stat-card.info { border-left-color: var(--color-info); }
        
        .stat-card .icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-card.success .value { color: var(--color-success); }
        .stat-card.warning .value { color: var(--color-warning); }
        .stat-card.danger .value { color: var(--color-danger); }
        .stat-card.info .value { color: var(--color-info); }
        
        .stat-card .label {
            color: var(--color-text-light);
            font-size: 0.95em;
        }
        
        /* 篩選器 */
        .filters {
            background: var(--color-background);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .filter-group label {
            font-size: 0.9em;
            color: var(--color-text-light);
            font-weight: 500;
            height: 18px;
            line-height: 18px;
            display: block;
            white-space: nowrap;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 14px;
            background: white;
            min-width: 150px;
            height: 38px;
        }
        
        .btn-filter {
            padding: 8px 20px;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            height: 38px;
        }
        
        .btn-filter:hover {
            background: var(--color-secondary);
            transform: translateY(-2px);
        }
        
        /* 功能分頁 */
        .function-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 24px;
            background: var(--color-background);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s;
            color: var(--color-text);
        }
        
        .tab:hover {
            background: var(--color-primary);
            color: white;
        }
        
        .tab.active {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        /* 內容區域 */
        .content-area {
            background: white;
            border-radius: 12px;
            padding: 20px;
            min-height: 400px;
        }
        
        .tab-pane {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        /* 表格樣式 */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .data-table thead {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: white;
        }
        
        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }
        
        .data-table tbody tr:hover {
            background: var(--color-background);
            cursor: pointer;
        }
        
        .data-table .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
            display: inline-block;
        }
        
        .status-badge.completed { background: #d1fae5; color: #065f46; }
        .status-badge.in-progress { background: #dbeafe; color: #1e40af; }
        .status-badge.pending { background: #fef3c7; color: #92400e; }
        .status-badge.uncompleted { background: #fee2e2; color: #991b1b; }
        .status-badge.overdue { background: #ef4444; color: white; }
        
        /* 任務內容樣式 */
        .task-title {
            font-weight: 500;
            color: var(--color-text);
        }
        
        .task-desc {
            color: var(--color-text-light);
            font-size: 0.9em;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            max-width: 400px;
            line-height: 1.4;
            cursor: help;
            position: relative;
            transition: all 0.3s;
        }
        
        .task-desc:hover {
            color: var(--color-primary);
        }
        
        /* 自訂工具提示樣式 */
        .task-desc-wrapper {
            position: relative;
        }
        
        .task-desc-tooltip {
            display: none;
            position: absolute;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            max-width: 400px;
            width: max-content;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            font-size: 0.9em;
            line-height: 1.5;
            left: 0;
            top: 100%;
            margin-top: 5px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .task-desc-wrapper:hover .task-desc-tooltip {
            display: block;
            animation: tooltipFadeIn 0.2s ease-in;
        }
        
        @keyframes tooltipFadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .task-desc-tooltip::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 20px;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 5px solid rgba(0, 0, 0, 0.9);
        }
        
        /* 分頁 */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .pagination button {
            padding: 8px 16px;
            border: 1px solid var(--color-border);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .pagination button:hover:not(:disabled) {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }
        
        .pagination button.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* 載入動畫 */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--color-text-light);
        }
        
        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        /* 空數據 */
        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-light);
        }
        
        .no-data .icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        /* 排行榜樣式 */
        .ranking-list {
            list-style: none;
        }
        
        .ranking-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: var(--color-background);
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .ranking-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow);
        }
        
        .ranking-medal {
            font-size: 2em;
            margin-right: 15px;
            min-width: 50px;
            text-align: center;
        }
        
        .ranking-info {
            flex: 1;
        }
        
        .ranking-name {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .ranking-details {
            font-size: 0.9em;
            color: var(--color-text-light);
        }
        
        .ranking-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--color-primary);
        }
        
        /* 響應式設計 */
        @media (max-width: 768px) {
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .function-tabs {
                overflow-x: auto;
            }
            
            .data-table {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 頂部導航 -->
        <div class="top-nav">
            <div class="nav-tabs">
                <a href="{{ url_for('reports_todo') }}" class="nav-tab active">📝 Todo 任務</a>
                <a href="{{ url_for('reports_meeting_tasks') }}" class="nav-tab">📋 Meeting Task</a>
            </div>
            <a href="{{ url_for('reports') }}" class="btn-home">← 返回報告中心</a>
        </div>

        <!-- 頁面標題 -->
        <div class="page-header">
            <h1>📝 Todo 任務報告</h1>
            <p>全面的任務統計分析與管理</p>
        </div>

        <!-- 統計卡片 -->
        <div class="stats-cards" id="statsCards">
            <div class="stat-card info">
                <div class="icon">📊</div>
                <div class="value" id="statTotal">-</div>
                <div class="label">總任務數</div>
            </div>
            <div class="stat-card success">
                <div class="icon">✅</div>
                <div class="value" id="statCompleted">-</div>
                <div class="label">已完成</div>
            </div>
            <div class="stat-card warning">
                <div class="icon">⏳</div>
                <div class="value" id="statInProgress">-</div>
                <div class="label">進行中</div>
            </div>
            <div class="stat-card danger">
                <div class="icon">🔴</div>
                <div class="value" id="statOverdue">-</div>
                <div class="label">逾期任務</div>
            </div>
        </div>

        <!-- 篩選器 -->
        <div class="filters" id="filters" style="display:none;">
            <div class="filter-group">
                <label>負責人</label>
                <select id="filterUser">
                    <option value="">全部</option>
                </select>
            </div>
            <div class="filter-group">
                <label>時間範圍</label>
                <select id="filterPeriod">
                    <option value="week">本週</option>
                    <option value="month" selected>本月</option>
                    <option value="last_month">上個月</option>
                    <option value="quarter">本季</option>
                    <option value="last_quarter">上一季</option>
                    <option value="first_half">上半年</option>
                    <option value="second_half">下半年</option>
                    <option value="year">本年</option>
                </select>
            </div>
            <div class="filter-group">
                <label>狀態</label>
                <select id="filterStatus">
                    <option value="">全部</option>
                    <option value="completed">已完成</option>
                    <option value="in-progress">進行中</option>
                    <option value="pending">待開始</option>
                    <option value="uncompleted">未完成</option>
                </select>
            </div>
            <button class="btn-filter" onclick="applyFilters()">🔍 套用篩選</button>
        </div>

        <!-- 功能分頁 -->
        <div class="function-tabs">
            <button class="tab active" data-tab="overview" onclick="switchTab('overview')">📊 概覽統計</button>
            <button class="tab" data-tab="historical" onclick="switchTab('historical')">📜 歷史任務</button>
            <button class="tab" data-tab="current" onclick="switchTab('current')">🔴 當前未完成</button>
            <button class="tab" data-tab="ranking" onclick="switchTab('ranking')">🏆 個人排行</button>
        </div>

        <!-- 內容區域 -->
        <div class="content-area">
            <!-- 概覽統計分頁 -->
            <div id="tab-overview" class="tab-pane active">
                <h2>📊 任務概覽統計</h2>
                <div class="stats-cards" style="margin-top: 20px;">
                    <div class="stat-card">
                        <h3>本週統計</h3>
                        <div class="value" id="weekTotal" style="font-size: 1.8em;">-</div>
                        <div class="label">完成率: <span id="weekRate">-</span>%</div>
                    </div>
                    <div class="stat-card">
                        <h3>本月統計</h3>
                        <div class="value" id="monthTotal" style="font-size: 1.8em;">-</div>
                        <div class="label">完成率: <span id="monthRate">-</span>%</div>
                    </div>
                    <div class="stat-card">
                        <h3>本年統計</h3>
                        <div class="value" id="yearTotal" style="font-size: 1.8em;">-</div>
                        <div class="label">完成率: <span id="yearRate">-</span>%</div>
                    </div>
                </div>
            </div>

            <!-- 歷史任務分頁 -->
            <div id="tab-historical" class="tab-pane">
                <h2>📜 歷史任務列表</h2>
                <div id="historicalContent"></div>
            </div>

            <!-- 當前未完成分頁 -->
            <div id="tab-current" class="tab-pane">
                <h2>🔴 當前未完成任務</h2>
                <div id="currentContent"></div>
            </div>

            <!-- 個人排行分頁 -->
            <div id="tab-ranking" class="tab-pane">
                <h2>🏆 個人排行榜</h2>
                <div id="rankingContent"></div>
            </div>
        </div>
    </div>

    <script>
        // 全域變數
        let currentTab = 'overview';
        let currentPage = 1;
        let currentPeriod = 'month';

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadOverviewData();
        });

        // 切換分頁
        function switchTab(tabName) {
            currentTab = tabName;
            
            // 更新分頁按鈕狀態
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // 更新內容區域
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // 根據頁籤動態顯示/隱藏篩選選項
            const filterStatus = document.getElementById('filterStatus');
            const filterStatusContainer = filterStatus?.parentElement;
            const filterUser = document.getElementById('filterUser');
            const filterUserContainer = filterUser?.parentElement;
            
            // 根據分頁載入數據和設置篩選顯示
            if (tabName === 'overview') {
                document.getElementById('filters').style.display = 'none';
                loadOverviewData();
            } else if (tabName === 'historical') {
                document.getElementById('filters').style.display = 'flex';
                // 歷史記錄：隱藏狀態篩選（都是已完成），顯示負責人篩選
                if (filterStatusContainer) {
                    filterStatusContainer.style.display = 'none';
                }
                if (filterUserContainer) {
                    filterUserContainer.style.display = 'block';
                }
                updateUserFilterForHistorical(); // 更新人員篩選清單
                loadHistoricalData();
            } else if (tabName === 'current') {
                document.getElementById('filters').style.display = 'flex';
                // 當前未完成：隱藏狀態篩選（本頁面就是未完成任務），顯示負責人篩選
                if (filterStatusContainer) {
                    filterStatusContainer.style.display = 'none';
                }
                if (filterUserContainer) {
                    filterUserContainer.style.display = 'block';
                }
                updateUserFilterForCurrent(); // 更新人員篩選清單
                loadCurrentData();
            } else if (tabName === 'ranking') {
                document.getElementById('filters').style.display = 'none';
                loadRankingData();
            }
        }

        // 載入概覽數據
        async function loadOverviewData() {
            try {
                const response = await fetch('/api/reports/todo/overview');
                const data = await response.json();
                
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                // 更新頂部統計卡片
                document.getElementById('statTotal').textContent = data.current.total || 0;
                document.getElementById('statInProgress').textContent = data.current.in_progress || 0;
                document.getElementById('statOverdue').textContent = data.current.overdue || 0;
                
                // 更新週月年統計
                document.getElementById('weekTotal').textContent = data.week.completed + '/' + data.week.total;
                document.getElementById('weekRate').textContent = data.week.completion_rate.toFixed(1);
                
                document.getElementById('monthTotal').textContent = data.month.completed + '/' + data.month.total;
                document.getElementById('monthRate').textContent = data.month.completion_rate.toFixed(1);
                document.getElementById('statCompleted').textContent = data.month.completed;
                
                document.getElementById('yearTotal').textContent = data.year.completed + '/' + data.year.total;
                document.getElementById('yearRate').textContent = data.year.completion_rate.toFixed(1);
                
            } catch (error) {
                console.error('Error loading overview:', error);
                showError('載入概覽數據失敗');
            }
        }

        // 載入歷史任務數據
        async function loadHistoricalData(page = 1) {
            const period = document.getElementById('filterPeriod').value;
            const userId = document.getElementById('filterUser').value;

            showLoading('historicalContent');

            try {
                let url = `/api/reports/todo/historical?period=${period}&page=${page}`;
                if (userId) url += `&user_id=${userId}`;

                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    showError(data.error, 'historicalContent');
                    return;
                }
                
                displayTaskTable(data, 'historicalContent');
                
            } catch (error) {
                console.error('Error loading historical:', error);
                showError('載入歷史任務失敗', 'historicalContent');
            }
        }

        // 載入當前任務數據
        async function loadCurrentData() {
            const userId = document.getElementById('filterUser').value;
            showLoading('currentContent');

            try {
                let url = '/api/reports/todo/current';
                if (userId) url += `?user_id=${userId}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    showError(data.error, 'currentContent');
                    return;
                }
                
                displayTaskTable(data, 'currentContent', true);
                
            } catch (error) {
                console.error('Error loading current:', error);
                showError('載入當前任務失敗', 'currentContent');
            }
        }

        // 載入排行榜數據
        async function loadRankingData() {
            showLoading('rankingContent');
            
            try {
                const response = await fetch('/api/reports/todo/ranking?period=month&metric=completed&limit=10');
                const data = await response.json();
                
                if (data.error) {
                    showError(data.error, 'rankingContent');
                    return;
                }
                
                displayRanking(data.ranking, 'rankingContent');
                
            } catch (error) {
                console.error('Error loading ranking:', error);
                showError('載入排行榜失敗', 'rankingContent');
            }
        }

        // 顯示任務表格
        function displayTaskTable(data, containerId, showOverdue = false) {
            const container = document.getElementById(containerId);
            
            if (!data.tasks || data.tasks.length === 0) {
                container.innerHTML = '<div class="no-data"><div class="icon">📭</div><p>沒有找到任務數據</p></div>';
                return;
            }
            
            let html = '<table class="data-table"><thead><tr>';
            html += '<th>編號</th>';
            html += '<th>任務標題</th>';
            html += '<th>任務內容</th>';
            html += '<th onclick="sortTable(\'' + containerId + '\', \'user_name\')" style="cursor: pointer;">負責人 ⇅</th>';
            html += '<th>狀態</th>';
            html += '<th onclick="sortTable(\'' + containerId + '\', \'due_date\')" style="cursor: pointer;">預計完成 ⇅</th>';
            if (showOverdue) html += '<th>逾期</th>';
            html += '</tr></thead><tbody>';
            
            data.tasks.forEach((task, index) => {
                const statusClass = task.status.replace('_', '-');
                const statusText = getStatusText(task.status);
                const overdueBadge = task.is_overdue ? '<span class="status-badge overdue">逾期</span>' : '';
                
                // 處理任務描述：使用多行顯示和自訂 tooltip
                const description = task.description || '無描述';
                const descHtml = description.length > 80 
                    ? `<div class="task-desc-wrapper">
                        <div class="task-desc">${escapeHtml(description)}</div>
                        <div class="task-desc-tooltip">${escapeHtml(description)}</div>
                       </div>`
                    : `<div class="task-desc">${escapeHtml(description)}</div>`;
                
                // 格式化日期，只顯示日期部分
                const dueDate = task.due_date ? formatDate(task.due_date) : '-';
                
                html += '<tr data-user="' + escapeHtml(task.user_name) + '" data-due-date="' + (task.due_date || '') + '">';
                html += `<td>${(currentPage - 1) * 50 + index + 1}</td>`;
                html += `<td class="task-title">${escapeHtml(task.title)}</td>`;
                html += `<td>${descHtml}</td>`;
                html += `<td>${escapeHtml(task.user_name)}</td>`;
                html += `<td><span class="status-badge ${statusClass}">${statusText}</span></td>`;
                html += `<td>${dueDate}</td>`;
                if (showOverdue) html += `<td>${overdueBadge}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            
            // 添加分頁
            if (data.total_pages > 1) {
                html += '<div class="pagination">';
                html += `<button ${data.page === 1 ? 'disabled' : ''} onclick="loadHistoricalData(${data.page - 1})">上一頁</button>`;
                html += `<span>第 ${data.page} / ${data.total_pages} 頁</span>`;
                html += `<button ${data.page === data.total_pages ? 'disabled' : ''} onclick="loadHistoricalData(${data.page + 1})">下一頁</button>`;
                html += '</div>';
            }
            
            container.innerHTML = html;
        }

        // 顯示排行榜
        function displayRanking(ranking, containerId) {
            const container = document.getElementById(containerId);
            
            if (!ranking || ranking.length === 0) {
                container.innerHTML = '<div class="no-data"><div class="icon">🏆</div><p>沒有排行數據</p></div>';
                return;
            }
            
            let html = '<ul class="ranking-list">';
            
            // 計算實際排名（考慮並列）
            let currentRank = 1;
            let prevValue = null;
            ranking.forEach((user, index) => {
                // 如果數值與前一名不同，更新排名
                if (prevValue !== null && user.completed_tasks !== prevValue) {
                    currentRank = index + 1;
                }
                prevValue = user.completed_tasks;
                
                const medal = currentRank === 1 ? '🥇' : currentRank === 2 ? '🥈' : currentRank === 3 ? '🥉' : `${currentRank}`;
                
                html += '<li class="ranking-item">';
                html += `<div class="ranking-medal">${medal}</div>`;
                html += '<div class="ranking-info">';
                html += `<div class="ranking-name">${escapeHtml(user.user_name)}</div>`;
                html += `<div class="ranking-details">${user.department} - ${user.unit}</div>`;
                html += `<div class="ranking-details">完成: ${user.completed_tasks}/${user.total_tasks} | 完成率: ${user.completion_rate.toFixed(1)}%</div>`;
                html += '</div>';
                html += `<div class="ranking-value">${user.completed_tasks}</div>`;
                html += '</li>';
            });
            
            html += '</ul>';
            container.innerHTML = html;
        }

        // 工具函數
        function showLoading(containerId) {
            document.getElementById(containerId).innerHTML = '<div class="loading">載入中</div>';
        }

        function showError(message, containerId = null) {
            const errorHtml = `<div class="no-data"><div class="icon">⚠️</div><p>${message}</p></div>`;
            if (containerId) {
                document.getElementById(containerId).innerHTML = errorHtml;
            } else {
                alert(message);
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'completed': '已完成',
                'in-progress': '進行中',
                'pending': '待開始',
                'uncompleted': '未完成'
            };
            return statusMap[status] || status;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                // 處理各種日期格式
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                
                // 只返回日期部分 YYYY-MM-DD
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (e) {
                return dateString;
            }
        }

        function applyFilters() {
            if (currentTab === 'historical') {
                updateUserFilterForHistorical(); // 根據時間範圍更新人員清單
                loadHistoricalData(1);
            } else if (currentTab === 'current') {
                loadCurrentData(); // 直接重新載入當前任務（會套用人員篩選）
            }
        }

        // 更新歷史任務的人員篩選清單
        async function updateUserFilterForHistorical() {
            const filterUser = document.getElementById('filterUser');
            const period = document.getElementById('filterPeriod').value;
            const currentSelection = filterUser.value; // 保存當前選擇

            try {
                // 獲取該時間範圍內的所有任務
                const response = await fetch(`/api/reports/todo/historical?period=${period}&per_page=1000`);
                const data = await response.json();

                if (data.error) {
                    console.error('Error fetching historical data:', data.error);
                    return;
                }

                // 提取唯一的人員列表
                const usersMap = new Map();
                data.tasks.forEach(task => {
                    if (task.user_id && task.user_name) {
                        usersMap.set(task.user_id, task.user_name);
                    }
                });

                // 更新下拉選單
                filterUser.innerHTML = '<option value="">全部</option>';
                
                // 按名稱排序
                const sortedUsers = Array.from(usersMap.entries()).sort((a, b) => a[1].localeCompare(b[1]));
                sortedUsers.forEach(([userId, userName]) => {
                    const option = document.createElement('option');
                    option.value = userId;
                    option.textContent = userName;
                    if (userId == currentSelection) {
                        option.selected = true;
                    }
                    filterUser.appendChild(option);
                });

            } catch (error) {
                console.error('Error updating user filter for historical:', error);
            }
        }

        // 更新當前未完成任務的人員篩選清單
        async function updateUserFilterForCurrent() {
            const filterUser = document.getElementById('filterUser');
            const currentSelection = filterUser.value; // 保存當前選擇

            try {
                // 獲取所有當前未完成任務
                const response = await fetch('/api/reports/todo/current');
                const data = await response.json();

                if (data.error) {
                    console.error('Error fetching current data:', data.error);
                    return;
                }

                // 提取唯一的人員列表
                const usersMap = new Map();
                data.tasks.forEach(task => {
                    if (task.user_id && task.user_name) {
                        usersMap.set(task.user_id, task.user_name);
                    }
                });

                // 更新下拉選單
                filterUser.innerHTML = '<option value="">全部</option>';
                
                // 按名稱排序
                const sortedUsers = Array.from(usersMap.entries()).sort((a, b) => a[1].localeCompare(b[1]));
                sortedUsers.forEach(([userId, userName]) => {
                    const option = document.createElement('option');
                    option.value = userId;
                    option.textContent = userName;
                    if (userId == currentSelection) {
                        option.selected = true;
                    }
                    filterUser.appendChild(option);
                });

            } catch (error) {
                console.error('Error updating user filter for current:', error);
            }
        }
        
        // 排序表格
        let sortDirection = {};
        function sortTable(containerId, column) {
            const table = document.querySelector('#' + containerId + ' table tbody');
            if (!table) return;
            
            const rows = Array.from(table.getElementsByTagName('tr'));
            const dir = sortDirection[column] === 'asc' ? 'desc' : 'asc';
            sortDirection[column] = dir;
            
            rows.sort((a, b) => {
                let aVal, bVal;
                
                if (column === 'user_name') {
                    aVal = a.dataset.user || '';
                    bVal = b.dataset.user || '';
                } else if (column === 'due_date') {
                    aVal = a.dataset.dueDate || '';
                    bVal = b.dataset.dueDate || '';
                }
                
                if (dir === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            // 重新排列行
            rows.forEach(row => table.appendChild(row));
        }
    </script>
</body>
</html>
