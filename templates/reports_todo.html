<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo ä»»å‹™å ±å‘Š</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.svg') }}" type="image/svg+xml">
    <style>
        :root {
            --color-primary: #667eea;
            --color-secondary: #764ba2;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-info: #3b82f6;
            --color-background: #f0f2f5;
            --color-white: #fff;
            --color-text: #333;
            --color-text-light: #666;
            --color-border: #e5e7eb;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--color-text);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--color-white);
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            padding: 30px;
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* é ‚éƒ¨å°èˆª */
        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--color-background);
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
        }
        
        .nav-tab {
            padding: 10px 20px;
            background: var(--color-background);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            text-decoration: none;
            color: var(--color-text);
        }
        
        .nav-tab:hover {
            background: var(--color-primary);
            color: white;
            transform: translateY(-2px);
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: white;
        }
        
        .btn-home {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .btn-home:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        /* é é¢æ¨™é¡Œ */
        .page-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .page-header h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }
        
        .page-header p {
            color: var(--color-text-light);
            font-size: 1.1em;
        }
        
        /* çµ±è¨ˆå¡ç‰‡ */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--color-background) 0%, #fff 100%);
            padding: 25px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            transition: all 0.3s;
            border-left: 4px solid var(--color-primary);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-card.success { border-left-color: var(--color-success); }
        .stat-card.warning { border-left-color: var(--color-warning); }
        .stat-card.danger { border-left-color: var(--color-danger); }
        .stat-card.info { border-left-color: var(--color-info); }
        
        .stat-card .icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-card.success .value { color: var(--color-success); }
        .stat-card.warning .value { color: var(--color-warning); }
        .stat-card.danger .value { color: var(--color-danger); }
        .stat-card.info .value { color: var(--color-info); }
        
        .stat-card .label {
            color: var(--color-text-light);
            font-size: 0.95em;
        }
        
        /* ç¯©é¸å™¨ */
        .filters {
            background: var(--color-background);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .filter-group label {
            font-size: 0.9em;
            color: var(--color-text-light);
            font-weight: 500;
            height: 18px;
            line-height: 18px;
            display: block;
            white-space: nowrap;
        }
        
        .filter-group select,
        .filter-group input {
            padding: 8px 12px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 14px;
            background: white;
            min-width: 150px;
            height: 38px;
        }
        
        .btn-filter {
            padding: 8px 20px;
            background: var(--color-primary);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
            height: 38px;
        }
        
        .btn-filter:hover {
            background: var(--color-secondary);
            transform: translateY(-2px);
        }
        
        /* åŠŸèƒ½åˆ†é  */
        .function-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 24px;
            background: var(--color-background);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s;
            color: var(--color-text);
        }
        
        .tab:hover {
            background: var(--color-primary);
            color: white;
        }
        
        .tab.active {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        /* å…§å®¹å€åŸŸ */
        .content-area {
            background: white;
            border-radius: 12px;
            padding: 20px;
            min-height: 400px;
        }
        
        .tab-pane {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        /* è¡¨æ ¼æ¨£å¼ */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .data-table thead {
            background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
            color: white;
        }
        
        .data-table th,
        .data-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
        }
        
        .data-table tbody tr:hover {
            background: var(--color-background);
            cursor: pointer;
        }
        
        .data-table .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 500;
            display: inline-block;
        }
        
        .status-badge.completed { background: #d1fae5; color: #065f46; }
        .status-badge.in-progress { background: #dbeafe; color: #1e40af; }
        .status-badge.pending { background: #fef3c7; color: #92400e; }
        .status-badge.uncompleted { background: #fee2e2; color: #991b1b; }
        .status-badge.overdue { background: #ef4444; color: white; }
        
        /* ä»»å‹™å…§å®¹æ¨£å¼ */
        .task-title {
            font-weight: 500;
            color: var(--color-text);
        }
        
        .task-desc {
            color: var(--color-text-light);
            font-size: 0.9em;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            max-width: 400px;
            line-height: 1.4;
            cursor: help;
            position: relative;
            transition: all 0.3s;
        }
        
        .task-desc:hover {
            color: var(--color-primary);
        }
        
        /* è‡ªè¨‚å·¥å…·æç¤ºæ¨£å¼ */
        .task-desc-wrapper {
            position: relative;
        }
        
        .task-desc-tooltip {
            display: none;
            position: absolute;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 15px;
            border-radius: 8px;
            max-width: 400px;
            width: max-content;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            font-size: 0.9em;
            line-height: 1.5;
            left: 0;
            top: 100%;
            margin-top: 5px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .task-desc-wrapper:hover .task-desc-tooltip {
            display: block;
            animation: tooltipFadeIn 0.2s ease-in;
        }
        
        @keyframes tooltipFadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .task-desc-tooltip::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 20px;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 5px solid rgba(0, 0, 0, 0.9);
        }
        
        /* åˆ†é  */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        .pagination button {
            padding: 8px 16px;
            border: 1px solid var(--color-border);
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .pagination button:hover:not(:disabled) {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }
        
        .pagination button.active {
            background: var(--color-primary);
            color: white;
            border-color: var(--color-primary);
        }
        
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* è¼‰å…¥å‹•ç•« */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--color-text-light);
        }
        
        .loading::after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }
        
        /* ç©ºæ•¸æ“š */
        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: var(--color-text-light);
        }
        
        .no-data .icon {
            font-size: 4em;
            margin-bottom: 20px;
            opacity: 0.3;
        }
        
        /* æ’è¡Œæ¦œæ¨£å¼ */
        .ranking-list {
            list-style: none;
        }
        
        .ranking-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: var(--color-background);
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .ranking-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow);
        }
        
        .ranking-medal {
            font-size: 2em;
            margin-right: 15px;
            min-width: 50px;
            text-align: center;
        }
        
        .ranking-info {
            flex: 1;
        }
        
        .ranking-name {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .ranking-details {
            font-size: 0.9em;
            color: var(--color-text-light);
        }
        
        .ranking-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--color-primary);
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .function-tabs {
                overflow-x: auto;
            }
            
            .data-table {
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é ‚éƒ¨å°èˆª -->
        <div class="top-nav">
            <div class="nav-tabs">
                <a href="{{ url_for('reports_todo') }}" class="nav-tab active">ğŸ“ Todo ä»»å‹™</a>
                <a href="{{ url_for('reports_meeting_tasks') }}" class="nav-tab">ğŸ“‹ Meeting Task</a>
            </div>
            <a href="{{ url_for('reports') }}" class="btn-home">â† è¿”å›å ±å‘Šä¸­å¿ƒ</a>
        </div>

        <!-- é é¢æ¨™é¡Œ -->
        <div class="page-header">
            <h1>ğŸ“ Todo ä»»å‹™å ±å‘Š</h1>
            <p>å…¨é¢çš„ä»»å‹™çµ±è¨ˆåˆ†æèˆ‡ç®¡ç†</p>
        </div>

        <!-- çµ±è¨ˆå¡ç‰‡ -->
        <div class="stats-cards" id="statsCards">
            <div class="stat-card info">
                <div class="icon">ğŸ“Š</div>
                <div class="value" id="statTotal">-</div>
                <div class="label">ç¸½ä»»å‹™æ•¸</div>
            </div>
            <div class="stat-card success">
                <div class="icon">âœ…</div>
                <div class="value" id="statCompleted">-</div>
                <div class="label">å·²å®Œæˆ</div>
            </div>
            <div class="stat-card warning">
                <div class="icon">â³</div>
                <div class="value" id="statInProgress">-</div>
                <div class="label">é€²è¡Œä¸­</div>
            </div>
            <div class="stat-card danger">
                <div class="icon">ğŸ”´</div>
                <div class="value" id="statOverdue">-</div>
                <div class="label">é€¾æœŸä»»å‹™</div>
            </div>
        </div>

        <!-- ç¯©é¸å™¨ -->
        <div class="filters" id="filters" style="display:none;">
            <div class="filter-group">
                <label>è² è²¬äºº</label>
                <select id="filterUser">
                    <option value="">å…¨éƒ¨</option>
                </select>
            </div>
            <div class="filter-group">
                <label>æ™‚é–“ç¯„åœ</label>
                <select id="filterPeriod">
                    <option value="week">æœ¬é€±</option>
                    <option value="month" selected>æœ¬æœˆ</option>
                    <option value="last_month">ä¸Šå€‹æœˆ</option>
                    <option value="quarter">æœ¬å­£</option>
                    <option value="last_quarter">ä¸Šä¸€å­£</option>
                    <option value="first_half">ä¸ŠåŠå¹´</option>
                    <option value="second_half">ä¸‹åŠå¹´</option>
                    <option value="year">æœ¬å¹´</option>
                </select>
            </div>
            <div class="filter-group">
                <label>ç‹€æ…‹</label>
                <select id="filterStatus">
                    <option value="">å…¨éƒ¨</option>
                    <option value="completed">å·²å®Œæˆ</option>
                    <option value="in-progress">é€²è¡Œä¸­</option>
                    <option value="pending">å¾…é–‹å§‹</option>
                    <option value="uncompleted">æœªå®Œæˆ</option>
                </select>
            </div>
            <button class="btn-filter" onclick="applyFilters()">ğŸ” å¥—ç”¨ç¯©é¸</button>
        </div>

        <!-- åŠŸèƒ½åˆ†é  -->
        <div class="function-tabs">
            <button class="tab active" data-tab="overview" onclick="switchTab('overview')">ğŸ“Š æ¦‚è¦½çµ±è¨ˆ</button>
            <button class="tab" data-tab="historical" onclick="switchTab('historical')">ğŸ“œ æ­·å²ä»»å‹™</button>
            <button class="tab" data-tab="current" onclick="switchTab('current')">ğŸ”´ ç•¶å‰æœªå®Œæˆ</button>
            <button class="tab" data-tab="ranking" onclick="switchTab('ranking')">ğŸ† å€‹äººæ’è¡Œ</button>
        </div>

        <!-- å…§å®¹å€åŸŸ -->
        <div class="content-area">
            <!-- æ¦‚è¦½çµ±è¨ˆåˆ†é  -->
            <div id="tab-overview" class="tab-pane active">
                <h2>ğŸ“Š ä»»å‹™æ¦‚è¦½çµ±è¨ˆ</h2>
                <div class="stats-cards" style="margin-top: 20px;">
                    <div class="stat-card">
                        <h3>æœ¬é€±çµ±è¨ˆ</h3>
                        <div class="value" id="weekTotal" style="font-size: 1.8em;">-</div>
                        <div class="label">å®Œæˆç‡: <span id="weekRate">-</span>%</div>
                    </div>
                    <div class="stat-card">
                        <h3>æœ¬æœˆçµ±è¨ˆ</h3>
                        <div class="value" id="monthTotal" style="font-size: 1.8em;">-</div>
                        <div class="label">å®Œæˆç‡: <span id="monthRate">-</span>%</div>
                    </div>
                    <div class="stat-card">
                        <h3>æœ¬å¹´çµ±è¨ˆ</h3>
                        <div class="value" id="yearTotal" style="font-size: 1.8em;">-</div>
                        <div class="label">å®Œæˆç‡: <span id="yearRate">-</span>%</div>
                    </div>
                </div>
            </div>

            <!-- æ­·å²ä»»å‹™åˆ†é  -->
            <div id="tab-historical" class="tab-pane">
                <h2>ğŸ“œ æ­·å²ä»»å‹™åˆ—è¡¨</h2>
                <div id="historicalContent"></div>
            </div>

            <!-- ç•¶å‰æœªå®Œæˆåˆ†é  -->
            <div id="tab-current" class="tab-pane">
                <h2>ğŸ”´ ç•¶å‰æœªå®Œæˆä»»å‹™</h2>
                <div id="currentContent"></div>
            </div>

            <!-- å€‹äººæ’è¡Œåˆ†é  -->
            <div id="tab-ranking" class="tab-pane">
                <h2>ğŸ† å€‹äººæ’è¡Œæ¦œ</h2>
                <div id="rankingContent"></div>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let currentTab = 'overview';
        let currentPage = 1;
        let currentPeriod = 'month';

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadOverviewData();
        });

        // åˆ‡æ›åˆ†é 
        function switchTab(tabName) {
            currentTab = tabName;
            
            // æ›´æ–°åˆ†é æŒ‰éˆ•ç‹€æ…‹
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // æ›´æ–°å…§å®¹å€åŸŸ
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            document.getElementById(`tab-${tabName}`).classList.add('active');
            
            // æ ¹æ“šé ç±¤å‹•æ…‹é¡¯ç¤º/éš±è—ç¯©é¸é¸é …
            const filterStatus = document.getElementById('filterStatus');
            const filterStatusContainer = filterStatus?.parentElement;
            const filterUser = document.getElementById('filterUser');
            const filterUserContainer = filterUser?.parentElement;
            
            // æ ¹æ“šåˆ†é è¼‰å…¥æ•¸æ“šå’Œè¨­ç½®ç¯©é¸é¡¯ç¤º
            if (tabName === 'overview') {
                document.getElementById('filters').style.display = 'none';
                loadOverviewData();
            } else if (tabName === 'historical') {
                document.getElementById('filters').style.display = 'flex';
                // æ­·å²è¨˜éŒ„ï¼šéš±è—ç‹€æ…‹ç¯©é¸ï¼ˆéƒ½æ˜¯å·²å®Œæˆï¼‰ï¼Œé¡¯ç¤ºè² è²¬äººç¯©é¸
                if (filterStatusContainer) {
                    filterStatusContainer.style.display = 'none';
                }
                if (filterUserContainer) {
                    filterUserContainer.style.display = 'block';
                }
                updateUserFilterForHistorical(); // æ›´æ–°äººå“¡ç¯©é¸æ¸…å–®
                loadHistoricalData();
            } else if (tabName === 'current') {
                document.getElementById('filters').style.display = 'flex';
                // ç•¶å‰æœªå®Œæˆï¼šéš±è—ç‹€æ…‹ç¯©é¸ï¼ˆæœ¬é é¢å°±æ˜¯æœªå®Œæˆä»»å‹™ï¼‰ï¼Œé¡¯ç¤ºè² è²¬äººç¯©é¸
                if (filterStatusContainer) {
                    filterStatusContainer.style.display = 'none';
                }
                if (filterUserContainer) {
                    filterUserContainer.style.display = 'block';
                }
                updateUserFilterForCurrent(); // æ›´æ–°äººå“¡ç¯©é¸æ¸…å–®
                loadCurrentData();
            } else if (tabName === 'ranking') {
                document.getElementById('filters').style.display = 'none';
                loadRankingData();
            }
        }

        // è¼‰å…¥æ¦‚è¦½æ•¸æ“š
        async function loadOverviewData() {
            try {
                const response = await fetch('/api/reports/todo/overview');
                const data = await response.json();
                
                if (data.error) {
                    showError(data.error);
                    return;
                }
                
                // æ›´æ–°é ‚éƒ¨çµ±è¨ˆå¡ç‰‡
                document.getElementById('statTotal').textContent = data.current.total || 0;
                document.getElementById('statInProgress').textContent = data.current.in_progress || 0;
                document.getElementById('statOverdue').textContent = data.current.overdue || 0;
                
                // æ›´æ–°é€±æœˆå¹´çµ±è¨ˆ
                document.getElementById('weekTotal').textContent = data.week.completed + '/' + data.week.total;
                document.getElementById('weekRate').textContent = data.week.completion_rate.toFixed(1);
                
                document.getElementById('monthTotal').textContent = data.month.completed + '/' + data.month.total;
                document.getElementById('monthRate').textContent = data.month.completion_rate.toFixed(1);
                document.getElementById('statCompleted').textContent = data.month.completed;
                
                document.getElementById('yearTotal').textContent = data.year.completed + '/' + data.year.total;
                document.getElementById('yearRate').textContent = data.year.completion_rate.toFixed(1);
                
            } catch (error) {
                console.error('Error loading overview:', error);
                showError('è¼‰å…¥æ¦‚è¦½æ•¸æ“šå¤±æ•—');
            }
        }

        // è¼‰å…¥æ­·å²ä»»å‹™æ•¸æ“š
        async function loadHistoricalData(page = 1) {
            const period = document.getElementById('filterPeriod').value;
            const userId = document.getElementById('filterUser').value;

            showLoading('historicalContent');

            try {
                let url = `/api/reports/todo/historical?period=${period}&page=${page}`;
                if (userId) url += `&user_id=${userId}`;

                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    showError(data.error, 'historicalContent');
                    return;
                }
                
                displayTaskTable(data, 'historicalContent');
                
            } catch (error) {
                console.error('Error loading historical:', error);
                showError('è¼‰å…¥æ­·å²ä»»å‹™å¤±æ•—', 'historicalContent');
            }
        }

        // è¼‰å…¥ç•¶å‰ä»»å‹™æ•¸æ“š
        async function loadCurrentData() {
            const userId = document.getElementById('filterUser').value;
            showLoading('currentContent');

            try {
                let url = '/api/reports/todo/current';
                if (userId) url += `?user_id=${userId}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.error) {
                    showError(data.error, 'currentContent');
                    return;
                }
                
                displayTaskTable(data, 'currentContent', true);
                
            } catch (error) {
                console.error('Error loading current:', error);
                showError('è¼‰å…¥ç•¶å‰ä»»å‹™å¤±æ•—', 'currentContent');
            }
        }

        // è¼‰å…¥æ’è¡Œæ¦œæ•¸æ“š
        async function loadRankingData() {
            showLoading('rankingContent');
            
            try {
                const response = await fetch('/api/reports/todo/ranking?period=month&metric=completed&limit=10');
                const data = await response.json();
                
                if (data.error) {
                    showError(data.error, 'rankingContent');
                    return;
                }
                
                displayRanking(data.ranking, 'rankingContent');
                
            } catch (error) {
                console.error('Error loading ranking:', error);
                showError('è¼‰å…¥æ’è¡Œæ¦œå¤±æ•—', 'rankingContent');
            }
        }

        // é¡¯ç¤ºä»»å‹™è¡¨æ ¼
        function displayTaskTable(data, containerId, showOverdue = false) {
            const container = document.getElementById(containerId);
            
            if (!data.tasks || data.tasks.length === 0) {
                container.innerHTML = '<div class="no-data"><div class="icon">ğŸ“­</div><p>æ²’æœ‰æ‰¾åˆ°ä»»å‹™æ•¸æ“š</p></div>';
                return;
            }
            
            let html = '<table class="data-table"><thead><tr>';
            html += '<th>ç·¨è™Ÿ</th>';
            html += '<th>ä»»å‹™æ¨™é¡Œ</th>';
            html += '<th>ä»»å‹™å…§å®¹</th>';
            html += '<th onclick="sortTable(\'' + containerId + '\', \'user_name\')" style="cursor: pointer;">è² è²¬äºº â‡…</th>';
            html += '<th>ç‹€æ…‹</th>';
            html += '<th onclick="sortTable(\'' + containerId + '\', \'due_date\')" style="cursor: pointer;">é è¨ˆå®Œæˆ â‡…</th>';
            if (showOverdue) html += '<th>é€¾æœŸ</th>';
            html += '</tr></thead><tbody>';
            
            data.tasks.forEach((task, index) => {
                const statusClass = task.status.replace('_', '-');
                const statusText = getStatusText(task.status);
                const overdueBadge = task.is_overdue ? '<span class="status-badge overdue">é€¾æœŸ</span>' : '';
                
                // è™•ç†ä»»å‹™æè¿°ï¼šä½¿ç”¨å¤šè¡Œé¡¯ç¤ºå’Œè‡ªè¨‚ tooltip
                const description = task.description || 'ç„¡æè¿°';
                const descHtml = description.length > 80 
                    ? `<div class="task-desc-wrapper">
                        <div class="task-desc">${escapeHtml(description)}</div>
                        <div class="task-desc-tooltip">${escapeHtml(description)}</div>
                       </div>`
                    : `<div class="task-desc">${escapeHtml(description)}</div>`;
                
                // æ ¼å¼åŒ–æ—¥æœŸï¼Œåªé¡¯ç¤ºæ—¥æœŸéƒ¨åˆ†
                const dueDate = task.due_date ? formatDate(task.due_date) : '-';
                
                html += '<tr data-user="' + escapeHtml(task.user_name) + '" data-due-date="' + (task.due_date || '') + '">';
                html += `<td>${(currentPage - 1) * 50 + index + 1}</td>`;
                html += `<td class="task-title">${escapeHtml(task.title)}</td>`;
                html += `<td>${descHtml}</td>`;
                html += `<td>${escapeHtml(task.user_name)}</td>`;
                html += `<td><span class="status-badge ${statusClass}">${statusText}</span></td>`;
                html += `<td>${dueDate}</td>`;
                if (showOverdue) html += `<td>${overdueBadge}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table>';
            
            // æ·»åŠ åˆ†é 
            if (data.total_pages > 1) {
                html += '<div class="pagination">';
                html += `<button ${data.page === 1 ? 'disabled' : ''} onclick="loadHistoricalData(${data.page - 1})">ä¸Šä¸€é </button>`;
                html += `<span>ç¬¬ ${data.page} / ${data.total_pages} é </span>`;
                html += `<button ${data.page === data.total_pages ? 'disabled' : ''} onclick="loadHistoricalData(${data.page + 1})">ä¸‹ä¸€é </button>`;
                html += '</div>';
            }
            
            container.innerHTML = html;
        }

        // é¡¯ç¤ºæ’è¡Œæ¦œ
        function displayRanking(ranking, containerId) {
            const container = document.getElementById(containerId);
            
            if (!ranking || ranking.length === 0) {
                container.innerHTML = '<div class="no-data"><div class="icon">ğŸ†</div><p>æ²’æœ‰æ’è¡Œæ•¸æ“š</p></div>';
                return;
            }
            
            let html = '<ul class="ranking-list">';
            
            // è¨ˆç®—å¯¦éš›æ’åï¼ˆè€ƒæ…®ä¸¦åˆ—ï¼‰
            let currentRank = 1;
            let prevValue = null;
            ranking.forEach((user, index) => {
                // å¦‚æœæ•¸å€¼èˆ‡å‰ä¸€åä¸åŒï¼Œæ›´æ–°æ’å
                if (prevValue !== null && user.completed_tasks !== prevValue) {
                    currentRank = index + 1;
                }
                prevValue = user.completed_tasks;
                
                const medal = currentRank === 1 ? 'ğŸ¥‡' : currentRank === 2 ? 'ğŸ¥ˆ' : currentRank === 3 ? 'ğŸ¥‰' : `${currentRank}`;
                
                html += '<li class="ranking-item">';
                html += `<div class="ranking-medal">${medal}</div>`;
                html += '<div class="ranking-info">';
                html += `<div class="ranking-name">${escapeHtml(user.user_name)}</div>`;
                html += `<div class="ranking-details">${user.department} - ${user.unit}</div>`;
                html += `<div class="ranking-details">å®Œæˆ: ${user.completed_tasks}/${user.total_tasks} | å®Œæˆç‡: ${user.completion_rate.toFixed(1)}%</div>`;
                html += '</div>';
                html += `<div class="ranking-value">${user.completed_tasks}</div>`;
                html += '</li>';
            });
            
            html += '</ul>';
            container.innerHTML = html;
        }

        // å·¥å…·å‡½æ•¸
        function showLoading(containerId) {
            document.getElementById(containerId).innerHTML = '<div class="loading">è¼‰å…¥ä¸­</div>';
        }

        function showError(message, containerId = null) {
            const errorHtml = `<div class="no-data"><div class="icon">âš ï¸</div><p>${message}</p></div>`;
            if (containerId) {
                document.getElementById(containerId).innerHTML = errorHtml;
            } else {
                alert(message);
            }
        }

        function getStatusText(status) {
            const statusMap = {
                'completed': 'å·²å®Œæˆ',
                'in-progress': 'é€²è¡Œä¸­',
                'pending': 'å¾…é–‹å§‹',
                'uncompleted': 'æœªå®Œæˆ'
            };
            return statusMap[status] || status;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                // è™•ç†å„ç¨®æ—¥æœŸæ ¼å¼
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                
                // åªè¿”å›æ—¥æœŸéƒ¨åˆ† YYYY-MM-DD
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (e) {
                return dateString;
            }
        }

        function applyFilters() {
            if (currentTab === 'historical') {
                updateUserFilterForHistorical(); // æ ¹æ“šæ™‚é–“ç¯„åœæ›´æ–°äººå“¡æ¸…å–®
                loadHistoricalData(1);
            } else if (currentTab === 'current') {
                loadCurrentData(); // ç›´æ¥é‡æ–°è¼‰å…¥ç•¶å‰ä»»å‹™ï¼ˆæœƒå¥—ç”¨äººå“¡ç¯©é¸ï¼‰
            }
        }

        // æ›´æ–°æ­·å²ä»»å‹™çš„äººå“¡ç¯©é¸æ¸…å–®
        async function updateUserFilterForHistorical() {
            const filterUser = document.getElementById('filterUser');
            const period = document.getElementById('filterPeriod').value;
            const currentSelection = filterUser.value; // ä¿å­˜ç•¶å‰é¸æ“‡

            try {
                // ç²å–è©²æ™‚é–“ç¯„åœå…§çš„æ‰€æœ‰ä»»å‹™
                const response = await fetch(`/api/reports/todo/historical?period=${period}&per_page=1000`);
                const data = await response.json();

                if (data.error) {
                    console.error('Error fetching historical data:', data.error);
                    return;
                }

                // æå–å”¯ä¸€çš„äººå“¡åˆ—è¡¨
                const usersMap = new Map();
                data.tasks.forEach(task => {
                    if (task.user_id && task.user_name) {
                        usersMap.set(task.user_id, task.user_name);
                    }
                });

                // æ›´æ–°ä¸‹æ‹‰é¸å–®
                filterUser.innerHTML = '<option value="">å…¨éƒ¨</option>';
                
                // æŒ‰åç¨±æ’åº
                const sortedUsers = Array.from(usersMap.entries()).sort((a, b) => a[1].localeCompare(b[1]));
                sortedUsers.forEach(([userId, userName]) => {
                    const option = document.createElement('option');
                    option.value = userId;
                    option.textContent = userName;
                    if (userId == currentSelection) {
                        option.selected = true;
                    }
                    filterUser.appendChild(option);
                });

            } catch (error) {
                console.error('Error updating user filter for historical:', error);
            }
        }

        // æ›´æ–°ç•¶å‰æœªå®Œæˆä»»å‹™çš„äººå“¡ç¯©é¸æ¸…å–®
        async function updateUserFilterForCurrent() {
            const filterUser = document.getElementById('filterUser');
            const currentSelection = filterUser.value; // ä¿å­˜ç•¶å‰é¸æ“‡

            try {
                // ç²å–æ‰€æœ‰ç•¶å‰æœªå®Œæˆä»»å‹™
                const response = await fetch('/api/reports/todo/current');
                const data = await response.json();

                if (data.error) {
                    console.error('Error fetching current data:', data.error);
                    return;
                }

                // æå–å”¯ä¸€çš„äººå“¡åˆ—è¡¨
                const usersMap = new Map();
                data.tasks.forEach(task => {
                    if (task.user_id && task.user_name) {
                        usersMap.set(task.user_id, task.user_name);
                    }
                });

                // æ›´æ–°ä¸‹æ‹‰é¸å–®
                filterUser.innerHTML = '<option value="">å…¨éƒ¨</option>';
                
                // æŒ‰åç¨±æ’åº
                const sortedUsers = Array.from(usersMap.entries()).sort((a, b) => a[1].localeCompare(b[1]));
                sortedUsers.forEach(([userId, userName]) => {
                    const option = document.createElement('option');
                    option.value = userId;
                    option.textContent = userName;
                    if (userId == currentSelection) {
                        option.selected = true;
                    }
                    filterUser.appendChild(option);
                });

            } catch (error) {
                console.error('Error updating user filter for current:', error);
            }
        }
        
        // æ’åºè¡¨æ ¼
        let sortDirection = {};
        function sortTable(containerId, column) {
            const table = document.querySelector('#' + containerId + ' table tbody');
            if (!table) return;
            
            const rows = Array.from(table.getElementsByTagName('tr'));
            const dir = sortDirection[column] === 'asc' ? 'desc' : 'asc';
            sortDirection[column] = dir;
            
            rows.sort((a, b) => {
                let aVal, bVal;
                
                if (column === 'user_name') {
                    aVal = a.dataset.user || '';
                    bVal = b.dataset.user || '';
                } else if (column === 'due_date') {
                    aVal = a.dataset.dueDate || '';
                    bVal = b.dataset.dueDate || '';
                }
                
                if (dir === 'asc') {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            // é‡æ–°æ’åˆ—è¡Œ
            rows.forEach(row => table.appendChild(row));
        }
    </script>
</body>
</html>
